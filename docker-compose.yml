# ============================================
# Physical AI & Robotics - Docker Compose
# Backend + Frontend + PostgreSQL (Local Dev)
# ============================================

version: '3.8'

services:
  # Backend API (FastAPI)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ai-robotics-backend
    ports:
      - "8001:8001"
    environment:
      # Gemini API
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - BASE_URL=${BASE_URL:-https://generativelanguage.googleapis.com/v1beta/openai/}
      - MODEL_NAME=${MODEL_NAME:-gemini-2.0-flash-exp}

      # Groq API
      - GROQ_API_KEY=${GROQ_API_KEY}

      # Qdrant (use cloud or local)
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - QDRANT_COLLECTION_NAME=${QDRANT_COLLECTION_NAME:-Physical_Robotics_Book}

      # PostgreSQL (local container)
      - NEON_DATABASE_URL=postgresql://postgres:postgres@postgres:5432/ai_robotics

      # Application settings
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DEBUG=${DEBUG:-True}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # CORS
      - CORS_ORIGINS=http://localhost:3000,http://localhost:3001

      # Chunking
      - CHUNK_SIZE=${CHUNK_SIZE:-1000}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}

      # RAG
      - TOP_K_RESULTS=${TOP_K_RESULTS:-5}
      - SIMILARITY_THRESHOLD=${SIMILARITY_THRESHOLD:-0.3}

      # JWT
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - JWT_EXPIRATION_DAYS=${JWT_EXPIRATION_DAYS:-7}

    depends_on:
      - postgres
      - qdrant

    volumes:
      - ./backend:/app

    restart: unless-stopped

    networks:
      - ai-robotics-network

  # PostgreSQL Database (Local Development)
  postgres:
    image: postgres:15-alpine
    container_name: ai-robotics-postgres
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=ai_robotics
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - ai-robotics-network

  # Qdrant Vector Database (Local Development)
  qdrant:
    image: qdrant/qdrant:latest
    container_name: ai-robotics-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant-data:/qdrant/storage
    restart: unless-stopped
    networks:
      - ai-robotics-network

  # Frontend (Docusaurus) - Optional for local dev
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ai-robotics-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
    volumes:
      - ./frontend:/app
      - /app/node_modules
    restart: unless-stopped
    networks:
      - ai-robotics-network
    depends_on:
      - backend

volumes:
  postgres-data:
    driver: local
  qdrant-data:
    driver: local

networks:
  ai-robotics-network:
    driver: bridge
